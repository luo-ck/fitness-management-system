# 消息中心优化实现方案

## 1. 核心目标

* 只显示已绑定的教练或用户

* 训练计划自动同步到实时对话框

* 现有反馈功能与对话框集成，反馈实时发送至对话框

* 双方实时消息交互优化

* 消息中心同步到教练界面

## 2. 实现思路

### 2.1 后端实现

#### 2.1.1 训练计划消息自动发送

* **修改文件**：`TrainingPlanServiceImpl.java`

* **实现逻辑**：在`insertTrainingPlan`和`updateTrainingPlan`方法末尾添加消息发送逻辑

* **依赖注入**：注入`IMessageService`

* **消息内容**：包含训练计划摘要、日期和ID

* **消息类型**：`training_plan`

* **接收对象**：训练计划关联的用户

#### 2.1.2 反馈消息自动同步

* **确保**：现有反馈功能在提交后，自动发送反馈消息到对话框

* **消息类型**：`feedback`

* **接收对象**：反馈关联的教练

### 2.2 前端实现

#### 2.2.1 实时消息更新

* **修改文件**：`ChatDialog.vue`

* **实现逻辑**：添加定时轮询机制

* **优化点**：

  * 仅在对话框打开时轮询

  * 轮询间隔合理（如10秒）

  * 轮询时携带上次消息时间戳，减少数据传输

#### 2.2.2 对话列表优化

* **修改文件**：`ConversationList.vue`

* **实现逻辑**：确保只显示已绑定的教练或用户

* **依赖**：利用现有的用户-教练绑定关系API

#### 2.2.3 教练界面同步

* **修改文件**：教练相关视图组件

* **实现逻辑**：复用优化后的消息中心组件

* **功能一致性**：确保教练和用户界面的消息功能一致

#### 2.2.4 消息详情优化

* **修改文件**：`ChatDialog.vue`

* **实现逻辑**：优化消息展示，特别是训练计划和反馈消息

* **交互优化**：

  * 训练计划消息支持点击查看详情

  * 反馈消息清晰展示评分和内容

  * 普通消息支持实时发送和接收

## 3. 关键技术点

### 3.1 消息类型处理

* **普通消息**：`message`

* **训练计划**：`training_plan`

* **反馈消息**：`feedback`

### 3.2 轮询机制

```javascript
// 在ChatDialog.vue中添加
const startPolling = () => {
  if (pollingTimer.value) return;
  pollingTimer.value = setInterval(async () => {
    await fetchMessages(props.currentConversation);
  }, 10000); // 10秒轮询一次
};
```

### 3.3 消息交互流程

* **教练发布训练计划** → 系统自动发送训练计划消息到用户对话框

* **用户提交反馈**（在我的训练计划中）→ 系统自动发送反馈消息到教练对话框

* **双方实时消息** → 直接通过对话框发送，实时更新

## 4. 实现步骤

### 4.1 后端修改

1. 在`TrainingPlanServiceImpl.java`中注入`IMessageService`
2. 在`insertTrainingPlan`和`updateTrainingPlan`方法末尾添加消息发送逻辑
3. 确保现有反馈功能在提交后自动发送反馈消息
4. 测试消息自动发送功能

### 4.2 前端修改

1. 优化`ChatDialog.vue`，添加轮询机制，实现实时消息更新
2. 确保`ConversationList.vue`只显示已绑定的教练或用户
3. 将优化后的消息中心组件同步到教练界面
4. 优化消息展示样式，提升用户体验
5. 测试所有功能：

   * 训练计划自动发送到对话框

   * 反馈自动同步到对话框

   * 双方实时消息交互

   * 教练界面同步

## 5. 预期效果

* 教练发布/更新训练计划后，用户立即在对话框中收到消息

* 用户在我的训练计划中提交的反馈，自动发送给教练

* 支持双方实时自定义消息交互

* 只显示已绑定的教练或用户

* 教练界面同步支持所有消息功能

## 6. 注意事项

* 保持现有代码结构不变

* 复用现有组件和API

* 确保数据一致性

* 优化性能，避免不必要的请求

* 提供良好的用户体验


# 修复自动发送消息排序问题

## 问题分析
1. **后端逻辑正确**：`selectMessagesByConversation`查询已经正确按照`send_time`升序排序
2. **前端处理问题**：轮询获取新消息时，直接将所有新消息添加到现有消息列表末尾，没有考虑发送时间
3. **导致结果**：自动发送的训练计划和反馈消息总是显示在聊天框底部，而不是按照发送时间排序

## 解决方案
修改`ChatDialog.vue`中的`fetchMessages`函数，确保所有消息（包括轮询获取的新消息）都按照发送时间正确排序

## 实现步骤

1. **修改`fetchMessages`函数**：
   - 移除当前的条件分支逻辑（轮询 vs 初始加载）
   - 统一处理所有消息获取场景
   - 合并新消息与现有消息
   - 按照发送时间重新排序所有消息
   - 更新未读消息计数

2. **确保消息排序逻辑**：
   - 比较消息的`sendTime`字段，确保所有消息按照发送时间升序排列
   - 使用JavaScript的`sort`方法，基于`sendTime`进行排序
   - 确保排序后的消息列表显示正确

3. **保持未读消息计数功能**：
   - 继续记录未读消息数量
   - 确保进入对话时重置未读计数
   - 确保轮询时正确更新未读计数

## 代码修改点

### `ChatDialog.vue`中的`fetchMessages`函数

**修改前**：
```javascript
if (timestamp && messages.value.length > 0) {
  // 轮询获取新消息，直接添加到末尾
  messages.value = [...messages.value, ...newMessages];
} else {
  // 初始加载，替换所有消息
  messages.value = newMessages;
}
```

**修改后**：
```javascript
if (timestamp && messages.value.length > 0) {
  // 合并新消息与现有消息
  const allMessages = [...messages.value, ...newMessages];
  // 按照发送时间排序
  messages.value = allMessages.sort((a, b) => {
    return new Date(a.sendTime) - new Date(b.sendTime);
  });
} else {
  // 初始加载，直接使用新消息
  messages.value = newMessages;
}
```

## 预期效果
1. 自动发送的训练计划和反馈消息将按照发送时间显示在聊天框中，而不是总是显示在底部
2. 所有消息（包括普通消息、训练计划和反馈）将按照发送时间的先后顺序排列
3. 未读消息计数功能保持正常
4. 聊天框的滚动行为保持正常

## 验证方法
1. 创建/更新训练计划，检查消息是否按照发送时间显示
2. 提交训练反馈，检查反馈消息是否按照发送时间显示
3. 轮询获取新消息，检查消息排序是否正确
4. 进入对话，检查未读消息计数是否重置
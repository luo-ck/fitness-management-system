# 训练计划和反馈自动发送功能优化

## 1. 核心优化目标

* 训练计划详情中包含教学视频项，如有则可点击查看
* 自动发送的反馈显示出对应哪个训练计划

## 2. 实现思路

### 2.1 后端优化

#### 2.1.1 优化反馈消息内容
* **修改文件**：`FeedbackServiceImpl.java`
* **实现逻辑**：在`sendFeedbackMessage`方法中，获取训练计划详情，将训练计划日期添加到反馈消息中
* **消息格式**："训练计划 [日期] 的反馈：感受|评分|评论"
* **关联字段**：保留原有的`relatedId`字段，确保可关联到具体训练计划

### 2.2 前端优化

#### 2.2.1 优化训练计划详情弹窗

* **修改文件**：`ChatDialog.vue`
* **实现逻辑**：
  - 确保训练计划详情包含完整的`exercises`数组
  - 为每个运动项添加视频查看功能
  - 检查`exercise.videoId`字段，如有则显示"查看视频"按钮
  - 实现视频查看功能，调用现有`viewVideo`方法

#### 2.2.2 优化反馈消息显示

* **修改文件**：`ChatDialog.vue`
* **实现逻辑**：
  - 修改反馈消息解析逻辑，提取训练计划信息
  - 优化反馈消息显示格式，明确显示关联的训练计划
  - 保留原有的反馈评分、感受和评论显示

#### 2.2.3 确保数据完整性

* **检查API响应**：确保`/training-plans/{planId}`API返回完整的训练计划数据，包括`exercises`数组和每个运动项的`videoId`
* **处理边界情况**：当`videoId`为`null`或`undefined`时，不显示视频查看按钮

## 3. 具体实现步骤

### 3.1 后端修改

1. **修改`FeedbackServiceImpl.java`**：
   - 在`sendFeedbackMessage`方法中，获取训练计划详情
   - 将训练计划日期添加到反馈消息内容
   - 确保消息格式清晰，包含训练计划标识

### 3.2 前端修改

1. **优化`ChatDialog.vue`的训练计划详情弹窗**：
   - 检查训练计划详情的`exercises`数组
   - 为每个运动项添加视频查看功能
   - 实现视频查看按钮的点击事件

2. **优化`ChatDialog.vue`的反馈消息显示**：
   - 修改反馈消息的解析逻辑
   - 显示关联的训练计划信息
   - 优化反馈消息的UI样式

## 4. 优化效果

* **训练计划详情**：包含完整的运动项列表，每个运动项如有教学视频，可直接点击查看
* **反馈消息**：明确显示对应哪个训练计划，便于教练理解反馈内容
* **用户体验**：提升了消息的可读性和实用性，方便用户快速获取关键信息
* **功能完整性**：补充了教学视频查看功能，完善了训练计划的展示

## 5. 测试要点

* 训练计划创建/更新后，自动发送的消息能正确显示
* 训练计划详情弹窗能显示所有运动项和对应的教学视频（如有）
* 点击教学视频按钮能正确打开视频
* 学员提交反馈后，自动发送的反馈消息能显示对应训练计划
* 反馈消息格式清晰，包含训练计划和反馈内容

## 6. 注意事项

* 保持现有功能的兼容性，不破坏已有逻辑
* 确保API返回的数据结构符合前端预期
* 处理好边界情况，如视频ID为空时的显示
* 优化UI样式，确保新添加的功能与现有设计风格一致